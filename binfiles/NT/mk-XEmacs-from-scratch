#!/usr/bin/env zsh

# Build XEmacs versions (21.4 and 21.5, both native and cygwin).
# The native versions are not installed, but the cygwin versions
# are installed to /usr/local/xemacs-21.x-$(today).
# All kits reference packages installed under e:/XEmacs

emulate -LR zsh
progname=${0:t}

# Optional '-l' argument means to build the libraries
if [[ $1 == -l ]]; then
  mk-xemacs-support-libs
  shift
fi

# The default is to build both 21.4 and 21.5
(( $# == 0 )) && set 21.4 21.5

# The version is based on the date.
# Capture that information now in case we're crossing midnight.
export VERSION=$(today)

: ${shortcut_dir:="$(cygpath $USERPROFILE)/Desktop/XEmacs Versions"}

for ver in $*; do
  case $ver in
  (21.4)

    # Make but don't install a native version.
    # We'll run it from the source directory.
    print "Building XEmacs $ver native"
    MakeNativeXEmacs --without-debug --package-root=e:/XEmacs 21.4

    # Make and install a cygwin version and make it the default.
    print "Building XEmacs $ver cygwin"
    mkdir ../build >& /dev/null
    pushd ../build
    MakeCygwinXEmacs xemacs-$ver-$VERSION t
    popd

    # Make shortcuts.
    pushd $shortcut_dir
    mkshortcut --desc="XEmacs $ver (native) $VERSION" --icon=/bin/run.exe --iconoffset=1 --name="XEmacs-$ver $VERSION (native)" --workingdir=$HOME $OLDPWD/xemacs-$ver-$VERSION/src/xemacs.exe
    mkshortcut --desc="XEmacs $ver (cygwin) $VERSION" --icon=/bin/run.exe --iconoffset=1  --arguments="$(ls /usr/local/xemacs-$ver-$VERSION/bin/xemacs-$ver*.exe)" --name="XEmacs-$ver $VERSION (cygwin)" --workingdir=$HOME /bin/run.exe
    popd
    ;;

  (21.5)

    # Make but don't install a native version.
    # We'll run it from the source directory.
    print "Building XEmacs $ver native"
    MakeNativeXEmacs --with-mule --package-root e:/XEmacs $ver

    # Make and install a cygwin version
    print "Building XEmacs $ver cygwin"
    mkdir ../build >& /dev/null
    pushd ../build
    MakeCygwinXEmacs xemacs-$ver-$VERSION
    popd

    # Make shortcuts.
    pushd $shortcut_dir
    mkshortcut --desc="XEmacs $ver (native, mule) $VERSION" --icon=/bin/run.exe --iconoffset=1 --name="XEmacs-$ver $VERSION (native)" --workingdir=$HOME $OLDPWD/xemacs-$ver-$VERSION/src/xemacs.exe
    mkshortcut --desc="XEmacs $ver (cygwin, mule) $VERSION" --icon=/bin/run.exe --iconoffset=1  --arguments="$(ls /usr/local/xemacs-$ver-$VERSION-mule/bin/xemacs-${ver}*.exe)" --name="XEmacs-$ver $VERSION (cygwin)" --workingdir=$HOME /bin/run.exe
    popd
    ;;

  (*)
      print -u2 "$progname: illegal version \"$ver\" specified."
      ;;
  esac
done

# Local Variables:
# mode: ksh
# sh-indentation: 2
# indent-tabs-mode: nil
# End:
